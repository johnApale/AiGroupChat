# AI Group Chat Application

**Technical Specification Document**  
Version 1.1 — MVP

---

## Project Summary

A group chat application with integrated AI agent capabilities. Users can create chat groups, invite members, and collaborate with an AI assistant that monitors and participates in conversations when invoked. The AI agent can be toggled on/off by group admins, and only sees messages sent while monitoring is enabled.

The architecture is designed with future scalability in mind — the AI service is built as a separate, standalone component that can eventually be sold as an independent product for integration with other platforms.

---

## Core Features (MVP)

1. **User Authentication** — Register, login, JWT-based sessions with refresh tokens, email verification, password reset
2. **Group Management** — Create groups, add/remove members, admin roles
3. **Real-time Messaging** — Send messages via REST, receive via WebSocket (SignalR)
4. **AI Monitoring Toggle** — Admin-only toggle; AI only sees messages sent while enabled
5. **AI Invocation** — Any member can @mention AI to ask questions
6. **Multi-provider Support** — Architecture supports Gemini, Claude, OpenAI, Grok
7. **AI Attachments** — AI can send file attachments (images, code, etc.)

---

## Tech Stack

| Component | Technology |
|-----------|------------|
| Main Backend | ASP.NET Core |
| Real-time | SignalR (minimal scope) |
| AI Service | Python (FastAPI) |
| Database | PostgreSQL (main app only) |
| ORM | Entity Framework Core |
| Authentication | ASP.NET Identity + JWT |
| Email Service | Resend |
| AI Provider (MVP) | Google Gemini |

---

## Configuration

### Token Expiration Times

| Token Type | Expiration | Notes |
|------------|------------|-------|
| Access Token (JWT) | 15 minutes | Short-lived for security |
| Refresh Token | 7 days | Stored in database, revocable |
| Email Confirmation Token | 24 hours | Single use, generated by Identity |
| Password Reset Token | 1 hour | Single use, security sensitive |

### Frontend URLs (Configurable)

The API requires frontend URLs for email links. These are configured via environment/appsettings:

| Setting | Example | Purpose |
|---------|---------|---------|
| `Frontend:BaseUrl` | `https://app.example.com` | Base URL for all frontend links |
| `Frontend:ConfirmEmailPath` | `/confirm-email` | Email confirmation page |
| `Frontend:ResetPasswordPath` | `/reset-password` | Password reset page |

**Email links format:**
- Confirm email: `{BaseUrl}{ConfirmEmailPath}?token={token}&email={email}`
- Reset password: `{BaseUrl}{ResetPasswordPath}?token={token}&email={email}`

---

## Architecture Overview

### Service Separation

The application is split into two services:

- **ASP.NET Core Main App** — Handles authentication, users, groups, messages, and real-time delivery
- **Python AI Service** — Stateless service that receives context and returns AI responses

The AI service is intentionally stateless with no database dependency. The main app passes all necessary context in each request, making the AI service portable and sellable as a standalone product.

### Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 CLIENTS                                     │
│                    (Web App / Mobile App / Desktop)                         │
└─────────────────────────────────────────────────────────────────────────────┘
                    │                                    │
                    │ REST (HTTP)                        │ WebSocket
                    │ - Auth                             │ - Real-time messages
                    │ - CRUD operations                  │ - Typing indicators
                    │ - Send messages                    │ - Presence
                    ▼                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          ASP.NET CORE MAIN APP                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │    Auth     │  │   Groups    │  │  Messages   │  │      SignalR        │ │
│  │  (Identity) │  │  Service    │  │  Service    │  │    (WebSocket)      │ │
│  └──────┬──────┘  └─────────────┘  └──────┬──────┘  └─────────────────────┘ │
│         │                                 │                                 │
│         │ Sends verification/             │ Detects @mention                │
│         │ reset emails                    ▼                                 │
│         │                          ┌─────────────┐                          │
│         │                          │  AI Client  │                          │
│         │                          │  Service    │                          │
│         │                          └──────┬──────┘                          │
│         │                                 │                                 │
└─────────┼─────────────────────────────────┼─────────────────────────────────┘
          │                                 │
          │                                 │ HTTP POST /generate
          ▼                                 │ Header: X-API-Key
┌─────────────────┐                         │
│  Resend Email   │                         │
│    Service      │                         │
│                 │                         │
│  - Confirm      │                         │
│  - Password     │                         │
│    Reset        │                         │
└─────────────────┘                         │
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          PYTHON AI SERVICE                                  │
│                            (Stateless)                                      │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Provider Interface                            │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐        │   │
│  │  │  Gemini   │  │  Claude   │  │  OpenAI   │  │   Grok    │        │   │
│  │  │ Provider  │  │ Provider  │  │ Provider  │  │ Provider  │        │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                            │                                │
│                                            │ Response:                      │
│                                            │ {                              │
│                                            │   response: "AI answer",       │
│                                            │   metadata: {...},             │
│                                            │   attachment: null             │
│                                            │ }                              │
└────────────────────────────────────────────┼────────────────────────────────┘
                                             │
                                             ▼
                                    ┌─────────────────┐
                                    │  External AI    │
                                    │    Providers    │
                                    │                 │
                                    │  Google Gemini  │
                                    │  Anthropic      │
                                    │  OpenAI         │
                                    │  xAI            │
                                    └─────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                              POSTGRESQL                                     │
│                         (Main App Only)                                     │
│                                                                             │
│  ai_providers │ users │ groups │ group_members │ messages │ ai_metadata    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Communication Pattern

```
┌──────────────┐                    ┌──────────────┐                    ┌──────────────┐
│    Client    │                    │   ASP.NET    │                    │  AI Service  │
└──────┬───────┘                    └──────┬───────┘                    └──────┬───────┘
       │                                   │                                   │
       │  POST /api/groups/:id/messages    │                                   │
       │  { content: "@gemini help" }      │                                   │
       │──────────────────────────────────>│                                   │
       │                                   │                                   │
       │                                   │  Store message (ai_visible=true)  │
       │                                   │  ────────────────────────────>    │
       │                                   │           [Database]              │
       │                                   │                                   │
       │     SignalR: MessageReceived      │                                   │
       │<──────────────────────────────────│                                   │
       │                                   │                                   │
       │                                   │  Detect @mention                  │
       │                                   │  Fetch context (ai_visible=true)  │
       │                                   │                                   │
       │     SignalR: AiTyping             │                                   │
       │<──────────────────────────────────│                                   │
       │                                   │                                   │
       │                                   │  POST /generate                   │
       │                                   │  X-API-Key: secret                │
       │                                   │──────────────────────────────────>│
       │                                   │                                   │
       │                                   │                                   │  Call Gemini API
       │                                   │                                   │  ─────────────>
       │                                   │                                   │
       │                                   │  { response, metadata }           │
       │                                   │<──────────────────────────────────│
       │                                   │                                   │
       │     SignalR: AiStoppedTyping      │                                   │
       │<──────────────────────────────────│                                   │
       │                                   │                                   │
       │                                   │  Store AI message + metadata      │
       │                                   │  ────────────────────────────>    │
       │                                   │           [Database]              │
       │                                   │                                   │
       │   SignalR: AiResponseReceived     │                                   │
       │<──────────────────────────────────│                                   │
       │                                   │                                   │
```

### REST vs WebSocket Usage

WebSockets (SignalR) are used minimally — only for server-to-client pushes:

- Broadcasting new messages to group members
- Broadcasting AI responses
- AI typing indicators
- User typing indicators
- Presence updates (who's online)

All other operations (sending messages, creating groups, toggling AI, etc.) use standard REST endpoints.

---

## Database Schema

### ai_providers

| Column | Type | Notes |
|--------|------|-------|
| id | UUID | PK |
| name | string | Unique ("gemini", "claude", "openai", "grok") |
| display_name | string | "Google Gemini", "Claude", etc. |
| is_enabled | boolean | Default true |
| base_url | string | Nullable, for non-standard endpoints |
| default_model | string | "gemini-1.5-pro", "gpt-4o", etc. |
| default_temperature | decimal | Default 0.7 |
| max_tokens_limit | integer | Provider's max context |
| input_token_cost | decimal | Cost per 1K input tokens |
| output_token_cost | decimal | Cost per 1K output tokens |
| created_at | timestamp | |
| updated_at | timestamp | |

*API keys stored in environment variables, referenced by provider name (e.g., GEMINI_API_KEY, CLAUDE_API_KEY)*

### AspNetUsers (ASP.NET Identity, extended)

| Column | Type | Notes |
|--------|------|-------|
| Id | string | PK, GUID |
| Email | string | Unique |
| UserName | string | Unique |
| PasswordHash | string | Identity managed |
| EmailConfirmed | boolean | Identity managed, default false |
| DisplayName | string | Custom field |
| CreatedAt | timestamp | Custom field |
| UpdatedAt | timestamp | Custom field |

*Note: ASP.NET Identity manages email confirmation tokens internally — no separate table needed.*

### refresh_tokens

| Column | Type | Notes |
|--------|------|-------|
| id | UUID | PK |
| user_id | string | FK → AspNetUsers |
| token | string | Unique |
| expires_at | timestamp | |
| revoked | boolean | |
| created_at | timestamp | |

### groups

| Column | Type | Notes |
|--------|------|-------|
| id | UUID | PK |
| name | string | |
| created_by | string | FK → AspNetUsers |
| ai_monitoring_enabled | boolean | Default false |
| ai_provider_id | UUID | FK → ai_providers, nullable |
| created_at | timestamp | |
| updated_at | timestamp | |

### group_members

| Column | Type | Notes |
|--------|------|-------|
| id | UUID | PK |
| group_id | UUID | FK → groups |
| user_id | string | FK → AspNetUsers |
| role | string | "admin" \| "member" |
| joined_at | timestamp | |

**Constraint:** UNIQUE(group_id, user_id)

### messages

| Column | Type | Notes |
|--------|------|-------|
| id | UUID | PK |
| group_id | UUID | FK → groups |
| sender_id | string | FK → AspNetUsers, nullable |
| sender_type | string | "user" \| "ai" |
| content | text | |
| ai_visible | boolean | Set at creation time |
| ai_provider_id | UUID | FK → ai_providers, nullable |
| attachment_url | string | Nullable |
| attachment_type | string | Nullable |
| attachment_name | string | Nullable |
| created_at | timestamp | |

### ai_response_metadata

| Column | Type | Notes |
|--------|------|-------|
| id | UUID | PK |
| message_id | UUID | FK → messages, unique |
| ai_provider_id | UUID | FK → ai_providers |
| model | string | Actual model used |
| tokens_input | integer | |
| tokens_output | integer | |
| latency_ms | integer | |
| cost_estimate | decimal | Nullable, calculated from provider costs |
| created_at | timestamp | |

### Entity Relationship Diagram

```
ai_providers
    │
    ├──< groups.ai_provider_id
    │
    ├──< messages.ai_provider_id
    │
    └──< ai_response_metadata.ai_provider_id

AspNetUsers
    │
    ├──< groups.created_by
    │
    ├──< group_members.user_id
    │
    ├──< messages.sender_id
    │
    └──< refresh_tokens.user_id

groups
    │
    ├──< group_members.group_id
    │
    └──< messages.group_id

messages
    │
    └──< ai_response_metadata.message_id
```

---

## API Contracts

### ASP.NET REST Endpoints

#### Authentication

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | /api/auth/register | Create account (sends confirmation email) |
| POST | /api/auth/login | Get JWT + refresh token (requires confirmed email) |
| POST | /api/auth/refresh | Exchange refresh token |
| POST | /api/auth/logout | Revoke refresh token |
| POST | /api/auth/confirm-email | Verify email with token |
| POST | /api/auth/resend-confirmation | Resend confirmation email |
| POST | /api/auth/forgot-password | Request password reset email |
| POST | /api/auth/reset-password | Reset password with token |

#### Users

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /api/users/me | Get current user |
| GET | /api/users/:id | Get user by ID |
| GET | /api/users?search= | Search users |

#### Groups

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | /api/groups | Create group |
| GET | /api/groups | List my groups |
| GET | /api/groups/:id | Get group details |
| PUT | /api/groups/:id | Update group (admin) |
| DELETE | /api/groups/:id | Delete group (admin) |

#### Group Members

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | /api/groups/:id/members | Add member (admin) |
| GET | /api/groups/:id/members | List members |
| DELETE | /api/groups/:id/members/:userId | Remove member (admin) |
| PUT | /api/groups/:id/members/:userId | Update role (admin) |

#### AI Settings

| Method | Endpoint | Description |
|--------|----------|-------------|
| PUT | /api/groups/:id/ai | Toggle/configure AI (admin) |
| GET | /api/groups/:id/ai | Get AI settings |

#### AI Providers

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /api/ai-providers | List available providers |
| GET | /api/ai-providers/:id | Get provider details |

#### Messages

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | /api/groups/:id/messages | Send message |
| GET | /api/groups/:id/messages | Get history (paginated) |

---

### Authentication Request/Response Contracts

#### POST /api/auth/register

**Request:**
```json
{
  "email": "user@example.com",
  "userName": "johndoe",
  "displayName": "John Doe",
  "password": "SecurePass123!"
}
```

**Response (201 Created):**
```json
{
  "message": "Registration successful. Please check your email to confirm your account.",
  "email": "user@example.com"
}
```

#### POST /api/auth/confirm-email

**Request:**
```json
{
  "email": "user@example.com",
  "token": "base64-encoded-token-from-email"
}
```

**Response (200 OK):**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "expiresAt": "2025-01-15T10:45:00Z",
  "user": {
    "id": "user-uuid",
    "email": "user@example.com",
    "userName": "johndoe",
    "displayName": "John Doe"
  }
}
```

#### POST /api/auth/resend-confirmation

**Request:**
```json
{
  "email": "user@example.com"
}
```

**Response (200 OK):**
```json
{
  "message": "If an unconfirmed account exists with this email, a confirmation link has been sent."
}
```

#### POST /api/auth/login

**Request:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}
```

**Response (200 OK):**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "expiresAt": "2025-01-15T10:45:00Z",
  "user": {
    "id": "user-uuid",
    "email": "user@example.com",
    "userName": "johndoe",
    "displayName": "John Doe"
  }
}
```

**Response (401 Unauthorized - Email not confirmed):**
```json
{
  "error": "EmailNotConfirmed",
  "message": "Please confirm your email before logging in."
}
```

#### POST /api/auth/refresh

**Request:**
```json
{
  "refreshToken": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
}
```

**Response (200 OK):**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "new-refresh-token-uuid",
  "expiresAt": "2025-01-15T10:45:00Z"
}
```

#### POST /api/auth/logout

**Request:**
```json
{
  "refreshToken": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
}
```

**Response (200 OK):**
```json
{
  "message": "Logged out successfully."
}
```

#### POST /api/auth/forgot-password

**Request:**
```json
{
  "email": "user@example.com"
}
```

**Response (200 OK):**
```json
{
  "message": "If an account exists with this email, a password reset link has been sent."
}
```

*Note: Always returns 200 to prevent email enumeration attacks.*

#### POST /api/auth/reset-password

**Request:**
```json
{
  "email": "user@example.com",
  "token": "base64-encoded-reset-token",
  "newPassword": "NewSecurePass456!"
}
```

**Response (200 OK):**
```json
{
  "message": "Password has been reset successfully. You can now log in with your new password."
}
```

---

### SignalR Events

#### Client → Server

| Event | Description |
|-------|-------------|
| JoinGroup(groupId) | Subscribe to group updates |
| LeaveGroup(groupId) | Unsubscribe |
| StartTyping(groupId) | User started typing |
| StopTyping(groupId) | User stopped typing |

#### Server → Client

| Event | Description |
|-------|-------------|
| MessageReceived(message) | New message in group |
| AiResponseReceived(message) | AI response in group |
| AiTyping(groupId, providerId) | AI is generating response |
| AiStoppedTyping(groupId, providerId) | AI finished (success or error) |
| UserTyping(groupId, userId) | Human is typing |
| UserStoppedTyping(groupId, userId) | Human stopped typing |
| UserOnline(groupId, userId) | User came online |
| UserOffline(groupId, userId) | User went offline |
| MemberAdded(groupId, user) | New member joined |
| MemberRemoved(groupId, userId) | Member removed |
| AiSettingsChanged(groupId, settings) | AI config updated |

---

### AI Service API

**Endpoint:** POST /generate  
**Authentication:** X-API-Key header

#### Request Body

```json
{
  "provider": "gemini",
  "context": [
    {
      "id": "msg-uuid",
      "senderType": "user",
      "senderName": "alice",
      "content": "I think we should use React",
      "createdAt": "2025-01-15T10:30:00Z"
    }
  ],
  "query": "what do you think about Vue instead?",
  "config": {
    "temperature": 0.7,
    "maxTokens": 2000
  }
}
```

#### Response Body

```json
{
  "response": "Vue is also a great option...",
  "metadata": {
    "provider": "gemini",
    "model": "gemini-1.5-pro",
    "tokensInput": 450,
    "tokensOutput": 280,
    "latencyMs": 2340
  },
  "attachment": null
}
```

#### Response with Attachment

```json
{
  "response": "Here's a diagram showing the architecture:",
  "metadata": { ... },
  "attachment": {
    "type": "image",
    "name": "architecture-diagram.png",
    "base64": "iVBORw0KGgo..."
  }
}
```

---

## Authentication Flows

### Email Verification Flow

When a user registers for an account:

```
┌──────────────┐                    ┌──────────────┐                    ┌──────────────┐
│   Frontend   │                    │   ASP.NET    │                    │    Resend    │
└──────┬───────┘                    └──────┬───────┘                    └──────┬───────┘
       │                                   │                                   │
       │  POST /api/auth/register          │                                   │
       │  { email, userName, password }    │                                   │
       │──────────────────────────────────>│                                   │
       │                                   │                                   │
       │                                   │  Create user (EmailConfirmed=false)
       │                                   │  ────────────────────────────>    │
       │                                   │           [Database]              │
       │                                   │                                   │
       │                                   │  Generate confirmation token      │
       │                                   │  (Identity built-in)              │
       │                                   │                                   │
       │                                   │  Send confirmation email          │
       │                                   │──────────────────────────────────>│
       │                                   │                                   │
       │                                   │                                   │  Deliver to
       │                                   │                                   │  user's inbox
       │                                   │                                   │  ──────────>
       │                                   │                                   │
       │  201: { message, email }          │                                   │
       │<──────────────────────────────────│                                   │
       │                                   │                                   │
       │  Show "Check your email" page     │                                   │
       │                                   │                                   │
```

When user clicks the confirmation link in email:

```
┌──────────────┐                    ┌──────────────┐
│   Frontend   │                    │   ASP.NET    │
└──────┬───────┘                    └──────┬───────┘
       │                                   │
       │  User clicks link in email:       │
       │  https://app.com/confirm-email    │
       │    ?token=xxx&email=user@...      │
       │                                   │
       │  Frontend extracts token & email  │
       │                                   │
       │  POST /api/auth/confirm-email     │
       │  { email, token }                 │
       │──────────────────────────────────>│
       │                                   │
       │                                   │  Validate token (Identity)
       │                                   │  Set EmailConfirmed = true
       │                                   │  ────────────────────────────>
       │                                   │           [Database]
       │                                   │
       │                                   │  Generate JWT + refresh token
       │                                   │  Store refresh token
       │                                   │  ────────────────────────────>
       │                                   │           [Database]
       │                                   │
       │  200: { accessToken, refreshToken,│
       │         expiresAt, user }         │
       │<──────────────────────────────────│
       │                                   │
       │  Store tokens, redirect to app    │
       │                                   │
```

### Password Reset Flow

When a user forgets their password:

```
┌──────────────┐                    ┌──────────────┐                    ┌──────────────┐
│   Frontend   │                    │   ASP.NET    │                    │    Resend    │
└──────┬───────┘                    └──────┬───────┘                    └──────┬───────┘
       │                                   │                                   │
       │  POST /api/auth/forgot-password   │                                   │
       │  { email }                        │                                   │
       │──────────────────────────────────>│                                   │
       │                                   │                                   │
       │                                   │  Look up user by email            │
       │                                   │  ────────────────────────────>    │
       │                                   │           [Database]              │
       │                                   │                                   │
       │                                   │  If user exists:                  │
       │                                   │  Generate reset token (Identity)  │
       │                                   │                                   │
       │                                   │  Send password reset email        │
       │                                   │──────────────────────────────────>│
       │                                   │                                   │
       │                                   │                                   │  Deliver to
       │                                   │                                   │  user's inbox
       │                                   │                                   │  ──────────>
       │                                   │                                   │
       │  200: { message }                 │                                   │
       │  (Always 200 to prevent           │                                   │
       │   email enumeration)              │                                   │
       │<──────────────────────────────────│                                   │
       │                                   │                                   │
       │  Show "Check your email" page     │                                   │
       │                                   │                                   │
```

When user clicks the reset link and submits new password:

```
┌──────────────┐                    ┌──────────────┐
│   Frontend   │                    │   ASP.NET    │
└──────┬───────┘                    └──────┬───────┘
       │                                   │
       │  User clicks link in email:       │
       │  https://app.com/reset-password   │
       │    ?token=xxx&email=user@...      │
       │                                   │
       │  Frontend shows new password form │
       │                                   │
       │  POST /api/auth/reset-password    │
       │  { email, token, newPassword }    │
       │──────────────────────────────────>│
       │                                   │
       │                                   │  Validate token (Identity)
       │                                   │  Update password hash
       │                                   │  Revoke all refresh tokens
       │                                   │  ────────────────────────────>
       │                                   │           [Database]
       │                                   │
       │  200: { message }                 │
       │<──────────────────────────────────│
       │                                   │
       │  Show success, redirect to login  │
       │                                   │
```

---

## Message Flow

When a user sends a message with an @mention to the AI:

1. User sends message via POST /api/groups/:id/messages
2. ASP.NET stores message in database with ai_visible flag
3. ASP.NET broadcasts MessageReceived to group via SignalR
4. ASP.NET detects @mention, fetches eligible context (ai_visible = true, capped)
5. ASP.NET broadcasts AiTyping to group via SignalR
6. ASP.NET calls AI service with context + query
7. AI service calls provider (Gemini), returns response
8. ASP.NET broadcasts AiStoppedTyping to group via SignalR
9. ASP.NET stores AI response as message + metadata
10. ASP.NET broadcasts AiResponseReceived to group via SignalR

---

## Context Management

For MVP, the main app sends all eligible messages (ai_visible = true) up to a configurable cap (recommended: 500-1000 messages). This keeps implementation simple while controlling costs.

**Future enhancement:** Implement RAG (Retrieval-Augmented Generation) for semantic search across larger message histories when users ask about older content.

---

## Future Considerations (Post-MVP)

- Message editing and deletion
- Message status (delivered, read)
- Direct messages (1:1)
- User file attachments
- RAG for deep message history search
- AI monitoring period tracking/audit log
- Horizontal scaling with Redis adapter for SignalR
- AI service as standalone SaaS product
